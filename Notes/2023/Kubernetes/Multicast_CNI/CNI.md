CNI <!-- omit in toc -->
===

**Table of Contents**
- [0. Multicast Test : iperf](#0-multicast-test--iperf)
- [1. Iptables](#1-iptables)
- [2. net.d](#2-netd)
- [3. config](#3-config)
- [4. ip route](#4-ip-route)

# 0. Multicast Test : iperf
> IPerf : Internet Performance Working Group
```bash
iperf -s -u -B 239.255.5.1 -i 1
------------------------------------------------------------
Server listening on UDP port 5001
Binding to local address 239.255.5.1
Joining multicast group  239.255.5.1
Receiving 1470 byte datagrams
UDP buffer size:  208 KByte (default)
------------------------------------------------------------
[  3] local 239.255.5.1 port 5001 connected with 172.100.1.2 port 40604
[ ID] Interval       Transfer     Bandwidth        Jitter   Lost/Total Datagrams
[  3]  0.0- 1.0 sec   129 KBytes  1.06 Mbits/sec   0.056 ms    0/   90 (0%)
[  3]  1.0- 2.0 sec   128 KBytes  1.05 Mbits/sec   0.059 ms    0/   89 (0%)
[  3]  2.0- 3.0 sec   128 KBytes  1.05 Mbits/sec   0.075 ms    0/   89 (0%)
[  3]  0.0- 3.0 sec   385 KBytes  1.05 Mbits/sec   0.075 ms    0/  268 (0%)
[  4] local 239.255.5.1 port 5001 connected with 172.100.1.2 port 40604
[  4]  0.0- 1.0 sec  0.00 Bytes  0.00 bits/sec   0.000 ms    0/    0 (-nan%)

iperf -c 239.255.5.1 -u -T 32 -t 3 -i 1
------------------------------------------------------------
Client connecting to 239.255.5.1, UDP port 5001
Sending 1470 byte datagrams, IPG target: 11215.21 us (kalman adjust)
Setting multicast TTL to 32
UDP buffer size:  208 KByte (default)
------------------------------------------------------------
[  3] local 172.100.1.2 port 40604 connected with 239.255.5.1 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0- 1.0 sec   131 KBytes  1.07 Mbits/sec
[  3]  1.0- 2.0 sec   128 KBytes  1.05 Mbits/sec
[  3]  0.0- 3.0 sec   385 KBytes  1.05 Mbits/sec
[  3] Sent 268 datagrams
```

# 1. Iptables
save/restore iptable rules
> The reset process does not reset or clean up iptables rules or IPVS tables.
If you wish to reset iptables, you must do so manually by using the "iptables" command.
```bash
# save
sudo /sbin/iptables-save > /root/kubeadm-rules.v4
sudo /sbin/ip6tables-save > /root/kubeadm-rules.v6

# restore
sudo /sbin/iptables-restore < /root/kubeadm-rules.v4
sudo /sbin/ip6tables-restore < /root/kubeadm-rules.v6
```

```bash
# Generated by iptables-save v1.8.4 on Sat Nov  4 11:21:55 2023
*nat
:PREROUTING ACCEPT [141:31432]
:INPUT ACCEPT [141:31432]
:OUTPUT ACCEPT [178:13345]
:POSTROUTING ACCEPT [178:13345]
COMMIT
# Completed on Sat Nov  4 11:21:55 2023
# Generated by iptables-save v1.8.4 on Sat Nov  4 11:21:55 2023
*filter
:INPUT ACCEPT [1206:3345290]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [827:91855]
:KUBE-FIREWALL - [0:0]
-A INPUT -j KUBE-FIREWALL
-A OUTPUT -j KUBE-FIREWALL
-A KUBE-FIREWALL ! -s 127.0.0.0/8 -d 127.0.0.0/8 -m comment --comment "block incoming localnet connections" -m conntrack ! --ctstate RELATED,ESTABLISHED,DNAT -j DROP
COMMIT
# Completed on Sat Nov  4 11:21:55 2023
# Generated by iptables-save v1.8.4 on Sat Nov  4 11:21:55 2023
*mangle
:PREROUTING ACCEPT [1206:3345290]
:INPUT ACCEPT [1206:3345290]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [827:91855]
:POSTROUTING ACCEPT [827:91855]
:KUBE-IPTABLES-HINT - [0:0]
:KUBE-KUBELET-CANARY - [0:0]
COMMIT
# Completed on Sat Nov  4 11:21:55 2023
```

```bash
# Generated by ip6tables-save v1.8.4 on Sat Nov  4 11:22:15 2023
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [28:1568]
:KUBE-KUBELET-CANARY - [0:0]
COMMIT
# Completed on Sat Nov  4 11:22:15 2023
# Generated by ip6tables-save v1.8.4 on Sat Nov  4 11:22:15 2023
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:KUBE-KUBELET-CANARY - [0:0]
COMMIT
# Completed on Sat Nov  4 11:22:15 2023
# Generated by ip6tables-save v1.8.4 on Sat Nov  4 11:22:15 2023
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [28:1568]
:POSTROUTING ACCEPT [28:1568]
:KUBE-IPTABLES-HINT - [0:0]
:KUBE-KUBELET-CANARY - [0:0]
COMMIT
# Completed on Sat Nov  4 11:22:15 2023
```

# 2. net.d
kubeadm reset log
> The reset process does not clean CNI configuration. To do so, you must remove /etc/cni/net.d

# 3. config
not required
> The reset process does not clean your kubeconfig files and you must remove them manually.
Please, check the contents of the $HOME/.kube/config file.

# 4. ip route
```bash
# flannel
sudo ip route flush dev cni0
ip link list | grep flan | awk '{print $2}' | cut -c 1-15 | sudo xargs -I {} ip link delete {}

sudo systemctl restart kubelet
```